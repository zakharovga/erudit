$(document).ready(function(){var q,a={},b=[],c=$("#modal-error"),d=$("#modal-error-body"),e=$("#modal-waiting"),f=$("#modal-info"),g=$("#modal-gameover"),h=$(".letter-container>div, .game-cell"),i=$("#make-move-btn"),j=$("#change-letters-btn"),k=$("#change-letters-div"),l=$("#send-changed-letters-btn"),m=$("#cancel-changing-letters-btn"),n=!1,o=$("#next-turn"),p=$("#gameId").text(),r=[],s=[],t=[],u=function(){var b,a=$("#timer"),c="01:00",d=function(){var c=a.text().split(":"),d=c[0],e=c[1];"00"===e?(e="59",d=""+(parseInt(d)-1),1===d.length&&(d="0"+d)):(e=""+(parseInt(e)-1),1===e.length&&(e="0"+e)),a.text(d+":"+e),"00:00"===a.text()&&(a.css("color","#ccc"),clearInterval(b))};return{start:function(){a.css("color","#fff"),a.text(c),b=setInterval(d,1e3)},stop:function(){clearInterval(b)}}}();if(!("WebSocket"in window))return d.text("\u0412\u0435\u0431\u0441\u043e\u043a\u0435\u0442\u044b \u043d\u0435 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u044e\u0442\u0441\u044f \u044d\u0442\u0438\u043c \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u043e\u043c. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 Internet Explorer 10 \u0438\u043b\u0438 \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0435 \u0432\u0435\u0440\u0441\u0438\u0438 Mozilla Firefox \u0438\u043b\u0438 Google Chrome."),void c.modal("show");e.modal("show");var v;try{v=new WebSocket("ws://"+window.location.host+"/game/"+p)}catch(w){return e.modal("hide"),d.text(w),void c.modal("show")}$("#pager").find("li a").click(function(a){a.preventDefault()});var x=function(){var e,f,g,a=15,b=$("#pager"),c=b.children().eq(0),d=b.children().eq(1),h=function(){c.removeClass("disabled"),f+=a;var b=f+a-1;f+a<g?e.css("display","none").slice(f,b+1).show():(e.css("display","none").slice(f).show(),d.addClass("disabled"))},i=function(){d.removeClass("disabled"),f-=a;var b=f+a-1;f>0?e.css("display","none").slice(f,b+1).show():(e.css("display","none").slice(f,b+1).show(),c.addClass("disabled"))};return{page:function(b){e=b.children(),g=e.size();var j=Math.ceil(g/a),k=0===g?0:g%a==0?a:g%a;f=(j-1)*a,e.hide();for(var l=0;l<k;l++){var m=e.eq((j-1)*a+l);m.hasClass("last-word")?m.show("slow"):m.show()}d.addClass("disabled"),g>a&&c.removeClass("disabled"),d.unbind("click").click(function(){return $(this).hasClass("disabled")?!1:(h(),!1)}),c.unbind("click").click(function(){return $(this).hasClass("disabled")?!1:(i(),!1)})}}}(),y=function(b){a.username==b?(n=!0,o.text("\u0412\u0430\u0448 \u0445\u043e\u0434!")):(n=!1,o.text("\u0425\u043e\u0434\u0438\u0442 "+b+"!"))},z=function(a,b){setTimeout(function(){var c=a.offset();a.css({top:0,left:0}).appendTo(b);var d=a.offset(),e=a.clone().appendTo("body");e.css({position:"absolute",left:c.left,top:c.top,"z-index":1e3}),a.hide(),e.animate({top:d.top,left:d.left},"fast",function(){a.show(),e.remove()})},0)};v.onopen=function(){},window.onbeforeunload=function(){v.onclose=function(){},v.close()},v.onclose=function(a){a.wasClean?(e.modal("hide"),d.text(a.reason),c.modal("show")):(e.modal("hide"),d.text("\u0421\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u0435 \u0441 \u0441\u0435\u0440\u0432\u0435\u0440\u043e\u043c \u0440\u0430\u0437\u043e\u0440\u0432\u0430\u043d\u043e. \u041a\u043e\u0434 "+a.code+": "+a.reason),c.modal("show"))},v.onerror=function(a){d.text(a.data),c.modal("show")},v.onmessage=function(c){var d=JSON.parse(c.data);if("GAME_STARTED"==d.action)return u.start(),e.modal("hide"),a.username=d.player.username,a.rating=Math.round(d.player.rating),a.guest=d.player.guest,D(d.givenLetters),A(d.opponents),y(d.nextMove),void(n&&(h.droppable("enable"),j.removeClass("disabled")));if("PLAYER_MADE_MOVE"==d.action){var l=$(".move-made");return l.draggable("destroy"),l.removeClass("move-made letter-line"),r=[],s=[],q="",y(d.nextMove),u.stop(),u.start(),D(d.letters),B(d.words,a.username),void(n&&(j.removeClass("disabled"),h.droppable("enable")))}if("OPPONENT_MADE_MOVE"==d.action){for(var m=d.moves.length-1;m>=0;m--){var o="r"+d.moves[m].row+"c"+d.moves[m].column,p=d.moves[m].letter.letter,v=d.moves[m].letter.value,w=$("<div/>",{"class":"letter-div",css:{display:"none"}});w.appendTo($("#"+o)),$("<span/>",{"class":"letter"}).text(p).appendTo(w),$("<span/>",{"class":"value"}).text(v).appendTo(w),w.fadeIn("slow")}return B(d.words,d.previousMove),y(d.nextMove),u.stop(),u.start(),void(n&&(j.removeClass("disabled"),h.droppable("enable")))}if("PLAYER_CHANGED_LETTERS"==d.action)return $(".letter-line").draggable("enable"),y(d.nextMove),$(".last-word").removeClass("last-word"),u.stop(),u.start(),C(d.changedLetters),void(n&&(j.removeClass("disabled"),h.droppable("enable")));if("OPPONENT_CHANGED_LETTERS"==d.action)return y(d.nextMove),$(".last-word").removeClass("last-word"),u.stop(),u.start(),void(n&&(j.removeClass("disabled"),h.droppable("enable")));if("TIME_OVER"==d.action){var x=n;y(d.nextMove),u.stop(),u.start(),f.modal("hide");var E=$(".letter-line");if(E.draggable("enable"),i.addClass("disabled"),x)if(h.droppable("disable"),"CHANGE_LETTERS"===q){$("#letter-line").tooltip("destroy");for(var m=0;m<t.length;m++)t[m].removeClass("selected");k.hide("slow"),E.unbind("click")}else if("MAKE_WORDS"===q){r=[];for(var F=0;F<s.length;F++)z(s[F].$letter,s[F].$initialParent);i.addClass("disabled"),s=[],$(".move-made").removeClass("move-made")}return void(n&&(j.removeClass("disabled"),h.droppable("enable")))}if("GAME_OVER"===d.action){var G=d.gameResult,H=$("<h4/>");G[0].points===G[1].points?H.text("\u041d\u0438\u0447\u044c\u044f").appendTo($("#gameover-info")):H.text("\u041f\u043e\u0431\u0435\u0434\u0438\u0442\u0435\u043b\u044c: "+G[0].player).appendTo($("#gameover-info"));for(var m=0;m<G.length;m++){var I=$("<li/>",{"class":"list-group-item"}),J=$("<span/>",{"class":"badge"}).text(G[m].points),K=$("<span/>").text(G[m].player);J.appendTo(I),K.appendTo(I),I.appendTo($("#gameover-ul"))}return g.modal("show"),void u.stop()}if("WRONG_FIRST_MOVE"===d.action)return h.droppable("enable"),i.removeClass("disabled"),$("#modal-info-header-span").text(" \u041d\u0435\u0432\u0435\u0440\u043d\u044b\u0439 \u043f\u0435\u0440\u0432\u044b\u0439 \u0445\u043e\u0434!"),$("#modal-info-body-h5").text(d.message),void f.modal("show");if("INCORRECT_MOVES"===d.action){h.droppable("enable"),i.removeClass("disabled"),$("#modal-info-header-span").text(" \u0411\u0443\u043a\u0432\u044b \u0432\u044b\u0441\u0442\u0430\u0432\u043b\u0435\u043d\u044b \u043d\u0435\u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u043e!");for(var L=d.message+" ",m=0;m<d.incorrectMoves.length;m++)L+=d.incorrectMoves[m].letter.letter+", ";return L=L.slice(0,-2),$("#modal-info-body-h5").text(L),void f.modal("show")}if("NO_SUCH_WORD"===d.action){h.droppable("enable"),i.removeClass("disabled"),$("#modal-info-header-span").text("\u0421\u043b\u043e\u0432\u043e \u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0441\u043b\u043e\u0432\u0430\u0440\u0435!");var L=d.message+" "+d.word;return $("#modal-info-body-h5").text(L),void f.modal("show")}if("WORD_ALREADY_USED"===d.action||"WORD_USED_TWICE"===d.action){h.droppable("enable"),i.removeClass("disabled"),$("#modal-info-header-span").text("\u041f\u043e\u0432\u0442\u043e\u0440\u043d\u043e\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435 \u0441\u043b\u043e\u0432\u0430");var L=d.message+" "+d.word;return $("#modal-info-body-h5").text(L),void f.modal("show")}if("OPPONENT_QUIT"==d.action){for(var m=0;m<b.length;m++)b[m].username===d.opponent&&$("#opponent"+m).addClass("player-disconnected");null!==d.nextMove&&(y(d.nextMove),n&&(j.removeClass("disabled"),h.droppable("enable")),u.stop(),u.start())}};var A=function(c){$("#player-name").text(a.username),$("#player-rating").text(a.rating),$("#player").show("slow");for(var d=0;d<c.length;d++)b[d]=c[d],b[d].rating=Math.round(c[d].rating),$("#opponent"+d+"-name").text(b[d].username),$("#opponent"+d+"-rating").text(b[d].rating),$("#opponent"+d).show("slow")},B=function(a,b){$(".last-word").removeClass("last-word");var c=$(".player-name");c.each(function(){var c=$(this);if(c.children().eq(0).text()===b){var d=c.next().children().eq(1);d.text(function(){var b=0;for(var c in a)if(a.hasOwnProperty(c)){var e=$("<li/>",{"class":"list-group-item",css:{display:"none"}});e.addClass("last-word");var f=$("<span/>",{"class":"badge"}).text(a[c]),g=$("<span/>").text(c);f.appendTo(e),g.appendTo(e),e.appendTo($("#words")),x.page($("#words")),b+=parseInt(a[c])}return parseInt(d.text())+b})}})},C=function(a){for(var b=0;b<t.length;b++){var c=$("<div/>",{"class":"letter-div letter-line",css:{display:"none"}});t[b].replaceWith(c),$("<span/>",{"class":"letter"}).text(a[b].letter).appendTo(c),$("<span/>",{"class":"value"}).text(a[b].value).appendTo(c),c.fadeIn("slow"),c.draggable({stack:".letter-line",revert:"invalid"})}},D=function(a){var b=0;$("div.letter-container>div:empty").each(function(){var c=$("<div/>",{"class":"letter-div letter-line",css:{display:"none"}});c.appendTo($(this)),$("<span/>",{"class":"letter"}).text(a[b].letter).appendTo(c),$("<span/>",{"class":"value"}).text(a[b].value).appendTo(c),c.fadeIn("slow"),c.draggable({stack:".letter-line",revert:"invalid"}),b++})},E=function(){null!=v&&(i.addClass("disabled"),v.send(JSON.stringify({action:"PLAYER_MADE_MOVE",move:r})),h.droppable("disable"))},F=function(a){a.addClass("selected"),l.removeClass("disabled"),t.push(a)},G=function(){q="CHANGE_LETTERS",t=[],i.addClass("disabled"),j.addClass("disabled");var a=$(".letter-line");a.draggable("disable"),k.show("slow"),a.click(function(){var b=$(this);F(b),b.unbind("click")}),$("#letter-line").tooltip("show")},H=function(a){return parseInt(a.substring(1,a.indexOf("c")))},I=function(a){return parseInt(a.substring(a.indexOf("c")+1))},J=function(){if(null!=v){var a=[];l.addClass("disabled"),$("#letter-line").tooltip("destroy"),k.hide("slow"),h.droppable("disable"),$(".letter-line").unbind("click");for(var b=0;b<t.length;b++){var c=t[b].children(":first"),d=c.next();a.push({letter:c.text(),value:d.text()})}v.send(JSON.stringify({action:"PLAYER_CHANGED_LETTERS",letters:a}))}},K=function(){for(var a=0;a<t.length;a++)t[a].removeClass("selected");t=[];var b=$(".letter-line");b.unbind("click"),b.draggable("enable"),l.addClass("disabled"),$("#letter-line").tooltip("destroy"),k.hide("slow"),j.removeClass("disabled")};i.click(E),j.click(G),l.click(J),m.click(K),$("#gameover-btn").click(function(){return window.location.replace("http://"+window.location.host+"/start"),!1}),h.droppable({accept:function(a){return 0===$(this).children(".letter-div").length&&a.hasClass("letter-div")},hoverClass:"hovered",disabled:!0,drop:function(a,b){var c=$(this),d=b.draggable,e=b.draggable.parent();if(z(d,c),e.hasClass("game-cell")){c.hasClass("game-cell")||d.removeClass("move-made");for(var f=0;f<r.length;f++){var g="r"+r[f].row+"c"+r[f].column;if(g===e.attr("id")){r.splice(f,1);break}}}if(c.hasClass("game-cell")){q="MAKE_WORDS",d.addClass("move-made");var h=c.attr("id"),k=H(h),l=I(h),m=d.children(":first"),n=m.next(),o={row:k,column:l,letter:{letter:m.text(),value:n.text()}};r.push(o)}for(var p=!0,f=0;f<s.length;f++)if(s[f].$letter===d){if(p=!1,s[f].$initialParent===c){s.splice(f,1);break}break}p&&s.push({$letter:d,$initialParent:e}),r.length>0?(i.removeClass("disabled"),j.addClass("disabled")):(i.addClass("disabled"),j.removeClass("disabled"))}})});